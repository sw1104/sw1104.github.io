---
title: "동적 sql 문과 준비된 문(Prepared Statement)"
excerpt: "동적 sql 문과 준비된 문(Prepared Statement)"

categories:
    - mysql
tags:
    - [mysql]

permalink: /mysql/query

toc: true
toc_sticky: true

published : false

date: 2023-05-21
last_modified_at: 2023-05-21
---

# 동적 SQL 문

동적 SQL 문은 실행 시점에 쿼리 문자열을 동적으로 생성하는 기술이다. 쿼리의 구조나 조건이 실행 시점에 결정되는 경우에 사용된다. 동적 SQL 문을 사용하면 쿼리를 프로그래밍적으로 생성할 수 있으므로, 동적으로 변경되는 요구 사항에 유연하게 대응할 수 있다.

## 동적 SQL 문 장단점

-  장점
    - 동적인 SQL 쿼리를 작성할 수 있다. 프로그래밍 언어와 연동하여 변수 값을 동적으로 결정할 수 있다.
    - 유연성이 있으며, 다양한 쿼리 조건을 다룰 수 있다.

- 단점
    - 보안 취약성이 존재할 수 있다. 입력값이 충분히 검증되지 않을 경우 SQL 인젝션 공격에 취약할 수 있다.
    - 쿼리 작성이 복잡해질 수 있고, 코드 가독성이 떨어질 수 있다.
    - 데이터베이스 엔진은 실행할 때마다 쿼리를 컴파일해야 하므로 약간의 성능 저하가 있을 수 있다.

## 동적 SQL 문을 사용하면 좋은 상황

1. 쿼리 구조가 동적으로 변경되는 경우: 동적 SQL 문은 쿼리의 구조를 동적으로 생성할 수 있다. 예를 들어, 다양한 조건에 따라 WHERE 절의 조건식이 변경되는 경우 동적 SQL 문을 사용하여 조건식을 유연하게 조합할 수 있다.

2. 복잡한 동적 쿼리를 작성해야 하는 경우 : 일부 상황에서는 복잡한 동적 쿼리를 작성해야할 수 도 있다. 예를 들어, 다중 조인, 동적 정렬, 그룹화 등을 포함하는 쿼리를 동적 SQL 문으로 작성할 수 있다.

3. 쿼리의 유연성이 요구되는 경우 : 실행 시점에 쿼리를 조합하기 때문에 유연적이다. 에로 사용자가 선택한 옵션에 따라 다양한 필터링 조건을 적용해야 하는 경우 동적 SQL 문을 사용할 수 있다.

4. 데이터베이스나 데이터베이스 라이브러리에서 준비된 문을 지원하지 않는 경우

## 동적 SQL 문 사용 시 주의 사항

1. SQL 인젝션 공격에 취약할 수 있으므로, 사용자 입력을 쿼리에 직접 포함시키기 전에 적절한 검증과 이스케이프를 수행해야 한다. 

2. 동적 SQL 문은 실행 시점에 쿼리를 생성하므로 오류가 발생할 수 있는 가능성이 높아질 수 있다.

3. 동적 SQL 문을 작성할 때는 가독성과 유지보수성을 고려해야 한다. 긴 문자열 조합이 필요할 수 있으며, 복잡한 쿼리 구조를 다룰 수 있기 때문에 코드를 이해하기 쉽고 유지 관리하기 쉽도록 주의해야 한다.

4. 동적 SQL 문을 사용할 때는 가능한 한 매개 변수화된 쿼리나 준비된 문(Prepared Statement)을 사용하는 것이 좋다. 이를 통해 SQL 인젝션 공격을 방지하고, 성능 향상을 얻을 수 있다.

## 동적 SQL 예시

```
const filter = 'completed'; // 동적으로 변경되는 조건
const query = `SELECT * FROM tasks WHERE status = '${filter}'`;
```

# 준비된 문(Prepared Statement)

SQL 쿼리를 미리 준비하여 컴파일한 후에 실행하는 기술이다. 쿼리의 구조는 미리 정의되어 있고 실행 시점에서 플레이스 홀더에 값을 바인딩하여 실행한다. 이를 통해 쿼리의 구조는 고정되어 있고 값만 동적으로 변경될 수 있어서 보안과 성능 측면에서 장점을 가지게 된다.

## 준비된 문 장단점

- 장점
    - 쿼리 컴파일과 최적화를 한 번만 수행하고 그 이후에는 값만 바인딩하여 실행하므로 성능 향상이 있고, 반복적인 쿼리 실행에서 효율적이다.
    - 플레이스홀더에 값이 바인딩 되므로 SQL 인젝션 공격을 방지할 수 있어 보안성이 높다.
    - 쿼리와 값이 분리되어 작성되므로 코드의 가독성과 유지보수성이 좋다.
    - 여러 번 실행할 수 있는 재사용 가능한 형태로 저장되기 때문에 동일한 쿼리를 다양한 값을 바인딩하여 반복적으로 실행할 수 있다.

- 단점
    - 쿼리를 미리 컴파일하여 메모리에 저장을 하기 때문에 많은 준비된 문을 사용하면 메모리 사용량이 증가할 수 있다. 하지만 대부분의 데이터베이스 시스템은 준비된 문을 효율적으로 관리하고 메모리 사용을 최적화하기 위한 기능을 제공한다.
    - 쿼리의 구조가 미리 정의되어 있기 때문에 동적으로 쿼리의 구조를 변경하는 경우에는 제한이 있을 수 있다.
    - 쿼리 구조를 미리 정의하고 바인딩을 처리하는 추가적인 코드 작성을 필요로 한다.

## 준비된 문(Prepared Statement)을 사용하면 좋은 상황

1. 보안 요구 사항이 높은 경우 : SQL 인젝션 공격을 예방할 수 있는 강력한 방어 메커니즘을 가진다. 외부 입력을 플레이스홀더에 바인딩하여 실행하기 때문에 악의적인 SQL 코드가 주입되는 것을 방지할 수 있다.

2. 동일한 쿼리를 반복적으로 실행해야 할 경우 : 쿼리의 구조를 미리 정의하고 바인딩을 처리하여 재사용 가능한 형태로 저장한다. 따라서 동일한 쿼리를 반복적으로 실행해야 할 때 효과적이다. 

3. 성능을 향상시키고자 하는 경우: 쿼리를 미리 컴파일 하고 최적화된 실행 계획을 생성하여 성능을 향상시킨다. 동일한 쿼리를 여러번 실행해야 할 때 매번 쿼리를 컴파일하지 않고 재사용할 수 있으므로 데이터베이스 서버의 부하를 줄이고 응답 시간을 단축시킬 수 있다.

4. 바인딩할 값이 동적으로 변경되는 경우 : 쿼리의 구조는 고정되고 값만 바인딩 하기 때문에 동적으로 값이 변경되는 상황에서 유연하게 대응할 수 있다.

5. 데이터 유형의 안정성을 보장해야 할 경우 : 쿼리와 바인딩되는 값의 데이터 유형을 미리 지정하여 안정성을 보장할 수 있다. 데이터 유형이 일치하지 않는 경우 자동으로 형 변환을 처리하여 데이터 무결성을 유지할 수 있다.

## 준비된 문(Prepared Statement) 사용 시 주의 사항

1. SQL 인젝션 공격을 예방할 수 있는 강력한 보안 기능을 제공하지만, 입력 값의 유효성을 검사하는 것은 여전히 중요하다. 외부 입력을 사용할 때는 적절한 유효성 검사를 수행하여 예상치 못한 입력 값으로 인한 문제를 방지해야 한다.

2. 쿼리와 바인딩되는 값의 데이터 유형을 정확하게 일치시켜야 한다. 데이터 유형이 일치하지 않는 경우 자동으로 형 변환이 수행되기는 하지만, 원하지 않는 결과를 초래할 수 있다.

3. 쿼리 내에 플레이스홀더를 사용하여 값을 바인딩한다. 이때 값의 바인딩 순서와 플레이스홀더의 위치를 일치시켜야 한다.

4. 데이터베이스 서버에서 사용하는 자원을 차지하므로 사용이 끝난 후에는 명시적으로 자원을 해제해야 한다. 준비된 문을 사용하는 프로그래밍 언어나 라이브러리에서 자원 관리를 위한 명시적인 닫기(close) 또는 해제(dispose) 메소드를 호출해야 한다.

5. 쿼리를 미리 컴파일하고 실행 계획을 재사용하여 성능을 향상시킨다. 그러나 많은 준비된 문을 생성하는 경우 메모리 사용량이 증가할 수 있다. 따라서 적절하게 관리해야 한다.

6. 준비된 문을 사용하는 동안 트랜잭션 처리를 고려해야 한다. 일부 데이터베이스 시스템에서는 Prepared Statement와 트랜잭션 간의 동작 방식이 특이할 수 있으므로 문서화된 가이드 라인을 참고하여 트랜잭션 처리를 올바르게 수행해야 한다.

## 준비된 문(Prepared Statement) 예시

```
const value = 1;
const query = 'SELECT * FROM users WHERE id = ?',[value];
```